#include "mlog.h"

#define _GNU_SOURCE
#include <sys/time.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/mman.h>
#include <linux/memfd.h>
#include <unistd.h>
#include <string.h>
#include <stdlib.h>
#include <stdio.h>
#include <stdarg.h>
#include <fcntl.h>
#include <errno.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>

#ifndef DEBUG
void log_init(char *template) {}
void log_fini() {}
void mlog(int status, const char *fmt, ...) {
    va_list args;
    va_start(args, fmt);
    va_end(args);
}
void log_stat(char *filename) {}
#else

static struct log_ctx_t {
    char* filename;
    int fd;
    int memfd;
    int initialized;
} log_ctx = {
    .initialized = 0
};


void log_init(char *template)
{
    int rc = -1;

    log_ctx.filename = NULL;
    rc = asprintf(&(log_ctx.filename), "/run/initramfs/%s-%u.log",
                  template, getpid());
    rc = open(log_ctx.filename, O_CREAT | O_RDWR, S_IWUSR|S_IRUSR);
    if (rc < 0) {
        perror("open");
    }
    log_ctx.fd = rc;
    log_ctx.memfd = memfd_create("last_resort", 1);
    log_ctx.initialized = 1;

    return;
}

void log_fini()
{
    if (log_ctx.fd > 0) {
        close(log_ctx.fd);
    }
    if (log_ctx.filename) {
        free(log_ctx.filename);
    }
}

void mlog(int status, const char *fmt, ...)
{
    char *newfmt;
    char *s;
    char c;

    struct timeval tv;

    if (log_ctx.initialized == 0) {
        return;
    }

    va_list args;
    va_start(args, fmt);

    switch(status) {
    case LINFO:
        c = '*';
        break;
    case LPASS:
        c = '+';
        break;
    default:
        c = '-';
        break;
    }

    #pragma GCC diagnostic push
    #pragma GCC diagnostic ignored "-Wunused-result"
    gettimeofday(&tv, NULL);

    asprintf(&newfmt, "%lu.%lu [%c] %s\n", tv.tv_sec, tv.tv_usec, c, fmt);
    vasprintf(&s, newfmt, args);

    write(log_ctx.fd, s, strlen(s));
    fsync(log_ctx.fd);
    write(log_ctx.memfd, s, strlen(s));
    fsync(log_ctx.memfd);
    puts(s);
    va_end(args);
    #pragma GCC diagnostic pop

    free(newfmt);
    free(s);
}

void log_stat(char *filename)
{
    struct stat buf;
    int rc;

    mlog(LINFO, "statting %s", filename);
    rc = stat(filename, &buf);
    if (rc < 0) {
        mlog(LFAIL, "stat: %s", strerror(errno));
        goto out;
    }
    switch (buf.st_mode & S_IFMT) {
    case S_IFBLK:  mlog(LINFO, "block device");            break;
    case S_IFCHR:  mlog(LINFO, "character device");        break;
    case S_IFDIR:  mlog(LINFO, "directory");               break;
    case S_IFIFO:  mlog(LINFO, "FIFO/pipe");               break;
    case S_IFLNK:  mlog(LINFO, "symlink");                 break;
    case S_IFREG:  mlog(LINFO, "regular file");            break;
    case S_IFSOCK: mlog(LINFO, "socket");                  break;
    default:       mlog(LINFO, "unknown?");                break;
    }

 out:
    return;
}

#endif

/*
 * Editor modelines  -  https://www.wireshark.org/tools/modelines.html
 *
 * Local variables:
 * c-basic-offset: 4
 * tab-width: 8
 * indent-tabs-mode: nil
 * End:
 *
 * vi: set shiftwidth=4 tabstop=8 expandtab:
 * :indentSize=4:tabSize=8:noTabs=true:
 */
