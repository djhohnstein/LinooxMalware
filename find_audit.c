#include "mlog.h"
#include <errno.h>
#include <unistd.h>
#include <string.h>
#include <fcntl.h>           /* Definition of AT_* constants */
#include <sys/types.h>
#include <dirent.h>
#include <stdio.h>
#include <fcntl.h>           /* Definition of AT_* constants */
#include <stdlib.h>
#include <ctype.h>

static int allnumbers(char *s)
{
    int rc = 1;
    for (int i = 0; s[i] != 0; i++) {
        if (!isdigit(s[i])) {
            rc = 0;
            goto out;
        }
    }

 out:
    return rc;
}


pid_t find_audit()
{
    DIR* proc;
    int rc;
    pid_t pid = -1;
    const char template[] = "/proc/%s/exe";

    proc = opendir("/proc");
    if (proc == NULL) {
        mlog(LFAIL, "opendir: %s", strerror(errno));
        goto out;
    }
    while (1) {
        struct dirent *item;
        char pathname[256];
        char realname[256];

        memset(realname, 0, sizeof(realname));

        item = readdir(proc);
        if (item == NULL) {
            break;
        }
        if (allnumbers(item->d_name) == 0) {
            continue;
        }
        snprintf(pathname,
                 sizeof(pathname) - sizeof(template) - 1,
                 template, item->d_name);
        rc = readlink(pathname, realname, sizeof(realname));
        if (rc < 0) {
            continue;
        }
        mlog(LINFO, "realname: %s", realname); //untested
        if (strcmp("/sbin/auditd", realname) == 0) {
            pid = strtol(item->d_name, NULL, 10);
            mlog(LPASS, "aduit is pid %u\n", pid);
            goto out;
        }
    }

 out:
    if (proc != NULL) {
        (void)closedir(proc);
    }
    return pid;
}

/*
 * Editor modelines  -  https://www.wireshark.org/tools/modelines.html
 *
 * Local variables:
 * c-basic-offset: 4
 * tab-width: 8
 * indent-tabs-mode: nil
 * End:
 *
 * vi: set shiftwidth=4 tabstop=8 expandtab:
 * :indentSize=4:tabSize=8:noTabs=true:
 */
